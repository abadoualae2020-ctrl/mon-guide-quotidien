<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Guide Quotidien</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÖ</text></svg>">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --blanc-fond: #F9F9F7;
            --vert-fonce: #1B3022;
            --marron: #7E5939;
            --marron-clair: #A68A64;
            --gris-leger: #ECECE8;
        }

        /* Couleurs quand le mode sombre est activ√© */
body.dark-mode {
    --blanc-fond: #121212;
    --vert-fonce: #81b29a; /* Vert plus clair pour le contraste */
    --marron: #e07a5f;
    --marron-clair: #f2cc8f;
    --gris-leger: #2a2a2a;
    --card-bg: #1e1e1e;
    --text-color: #e0e0e0;
}

        body { font-family: 'Inter', sans-serif; background-color: var(--blanc-fond); color: var(--vert-fonce); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding-bottom: 40px; }

        /* --- AUTHENTIFICATION --- */
        #auth-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100%; background: var(--blanc-fond); position: fixed; z-index: 1000; }
        .auth-card { background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); text-align: center; width: 320px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--gris-leger); border-radius: 12px; box-sizing: border-box; outline: none; }
        .btn-auth { width: 100%; padding: 15px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; margin-top: 10px; }

        /* --- INTERFACE PRINCIPALE --- */
        #main-interface { display: none; width: 100%; flex-direction: column; align-items: center; }

        .tabs-container { width: 100%; display: flex; justify-content: center; position: sticky; top: 0; background: var(--blanc-fond); padding: 20px 0; z-index: 100; border-bottom: 1px solid var(--gris-leger); }
        .tabs { display: flex; gap: 8px; background: var(--gris-leger); padding: 6px; border-radius: 50px; overflow-x: auto; max-width: 95%; }
        
        .tab-btn { 
            padding: 10px 20px; border: none; background: none; cursor: pointer; border-radius: 40px; color: var(--marron); font-weight: 600; white-space: nowrap; transition: 0.3s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .tab-btn.active { background-color: var(--vert-fonce); color: white; }

        .content-section { display: none; width: 90%; max-width: 500px; margin-top: 20px; animation: fadeIn 0.4s ease-out; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: white; padding: 25px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.04); border: 1px solid var(--gris-leger); margin-bottom: 20px; }
        .action-btn { background-color: var(--vert-fonce); color: white; border: none; padding: 15px; width: 100%; border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 10px; }
        .logout-btn { position: absolute; top: 20px; right: 20px; background: white; border: 1px solid var(--marron); color: var(--marron); padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; z-index: 200; }

        .timer-display { font-size: 3.5rem; font-weight: bold; text-align: center; color: var(--marron); margin: 10px 0; }
        .task-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--gris-leger); }

        @media (max-width: 400px) {
    .edit-agenda { font-size: 0.75rem !important; }
    #calendar-container div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
        gap: 5px !important;
    }
}

    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 id="auth-title">Connexion</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Mot de passe">
            <button class="btn-auth" style="background: var(--vert-fonce); color: white;" onclick="signIn()">Se connecter</button>
            <button class="btn-auth" style="background: none; color: var(--marron); border: 1px solid var(--marron); font-size: 0.8rem;" onclick="toggleAuthMode()" id="switch-btn">S'inscrire</button>
        </div>
    </div>

    <div id="main-interface">
        <button class="logout-btn" onclick="signOut()">D√©connexion</button>
        <button class="logout-btn" onclick="toggleDarkMode()" style="right: 140px;">üåì Mode</button>
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab-btn active" onclick="openTab(event, 'planning')">üìå taches</button>
                <button class="tab-btn" onclick="openTab(event, 'revisions')">‚è≥ R√©visions</button>
                <button class="tab-btn" onclick="openTab(event, 'cuisine')">üç≥ Loisirs</button>
                <button class="tab-btn" onclick="openTab(event, 'bienetre')">üßò Zen</button>
                <button class="tab-btn" onclick="openTab(event, 'conseils')">üí° Astuces</button>
                <button class="tab-btn" onclick="openTab(event, 'agenda')">üìÖ Agenda</button>
                <button class="tab-btn" onclick="openTab(event, 'chat')">üí¨ Chat</button>
            </div>
        </div>

        <div id="planning" class="content-section active">
            <div class="card">
                <h2 id="planning-title">üìå‚Äã Mes taches</h2>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="taskInput" placeholder="Ajouter une t√¢che...">
                    <button onclick="addTask()" style="background: var(--marron); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer;">+</button>
                </div>
                <div id="taskList" style="margin-top: 20px;"></div>
            </div>
        </div>

        <div id="revisions" class="content-section">
            <div class="card">
                <h2>‚è≤Ô∏è Mode Focus (Pomodoro)</h2>
                <div class="timer-display" id="timer">25:00</div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-btn" id="startBtn" onclick="toggleTimer()">D√©marrer</button>
                    <button class="action-btn" style="background: var(--gris-leger); color: var(--vert-fonce);" onclick="resetTimer()">Reset</button>
                </div>
            </div>

            <div class="card">
                <h2>üìö Techniques de R√©vision</h2>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                    <details style="background: var(--blanc-fond); padding: 10px; border-radius: 12px;">
                        <summary style="font-weight: bold; cursor: pointer;">üí° La M√©thode Feynman</summary>
                        <p style="font-size: 0.9rem; margin-top: 5px;">Explique un concept complexe comme si tu t'adressais √† un enfant de 5 ans. Si tu bloques, c'est l√† que tu dois r√©viser.</p>
                    </details>
                    <details style="background: var(--blanc-fond); padding: 10px; border-radius: 12px;">
                        <summary style="font-weight: bold; cursor: pointer;">üÉè R√©p√©tition Espac√©e</summary>
                        <p style="font-size: 0.9rem; margin-top: 5px;">Revois tes notes √† J+1, J+3, J+7 et J+30 pour ancrer l'information dans ta m√©moire √† long terme.</p>
                    </details>
                    <details style="background: var(--blanc-fond); padding: 10px; border-radius: 12px;">
                        <summary style="font-weight: bold; cursor: pointer;">‚úçÔ∏è Active Recall</summary>
                        <p style="font-size: 0.9rem; margin-top: 5px;">Ferme ton livre et √©cris tout ce dont tu te souviens sur une feuille blanche avant de v√©rifier.</p>
                    </details>
                    <details style="background: var(--blanc-fond); padding: 10px; border-radius: 12px;">
                        <summary style="font-weight: bold; cursor: pointer;">üß† La m√©thode du Palais Mental</summary>
                        <p style="font-size: 0.9rem; margin-top: 5px;">Imagine un lieu que tu connais par c≈ìur (ta maison). Place les concepts √† r√©viser dans chaque pi√®ce.</p>
                    </details>
                    <details style="background: var(--blanc-fond); padding: 10px; border-radius: 12px;">
                        <summary style="font-weight: bold; cursor: pointer;">üìµ Mode Avion Obligatoire</summary>
                        <p style="font-size: 0.9rem; margin-top: 5px;">Mettre son t√©l√©phone dans une autre pi√®ce multiplie ta capacit√© de m√©morisation par 2.</p>
                    </details>
                </div>
            </div>
        </div>

        <div id="cuisine" class="content-section">
            <div class="card">
                <h2>üç≥ Id√©es Cuisine</h2>
                <button class="action-btn" onclick="randomRecipe()">G√©n√©rer une id√©e</button>
                <div id="recipeDisplay" style="margin-top: 15px; color: var(--marron);"></div>
            </div>
            <div class="card">
                <h2>üé¨ Session Cin√©</h2>
                <button class="action-btn" style="background: var(--marron-clair);" onclick="randomMovie()">Quel film regarder ?</button>
                <p id="movieDisplay" style="margin-top: 15px; font-weight: bold; text-align: center; color: var(--marron);"></p>
            </div>
        </div>

        <div id="bienetre" class="content-section">
            <div class="card">
                <h2>‚ö° Flash Sport (Sans mat√©riel)</h2>
                <button class="action-btn" onclick="generateWorkout()">G√©n√©rer un exercice</button>
                <div id="workoutBox" style="display:none; margin-top: 20px; padding: 15px; background: #f0f4f1; border-radius: 12px; border-left: 5px solid var(--vert-fonce);">
                    <h3 id="workoutTitle" style="margin-top:0; color: var(--vert-fonce);"></h3>
                    <p id="workoutDesc" style="font-size: 0.9rem; margin-bottom: 10px;"></p>
                    <p style="font-weight: bold; color: var(--marron);" id="workoutRep"></p>
                </div>
            </div>
            <div class="card">
                <h2>üßò Relaxation</h2>
                <button class="action-btn" style="background: var(--marron-clair);" onclick="startBreathing()">Exercice de respiration (4-4-4)</button>
                <p id="breathText" style="font-size: 1.2rem; text-align: center; margin-top: 15px; color: var(--marron);"></p>
            </div>
        </div>

        <div id="conseils" class="content-section">
            <div class="card">
                <h2>üí° Astuce du Jour</h2>
                <button class="action-btn" onclick="generateTip()">D√©couvrir une astuce</button>
                <div id="tipBox" style="display:none; margin-top: 20px; padding: 15px; background: var(--gris-leger); border-radius: 12px; border-left: 5px solid var(--marron);">
                    <p id="tipText" style="font-style: italic; line-height: 1.5; margin: 0;"></p>
                </div>
            </div>
            <div class="card">
                <h2>üìö Les Essentiels</h2>
                <ul style="line-height: 2; padding-left: 20px;">
                    <li><b>Eau :</b> 1 verre au r√©veil = cerveau r√©veill√©.</li>
                    <li><b>Sommeil :</b> Pas d'√©cran 30 min avant de dormir.</li>
                    <li><b>Focus :</b> Une seule t√¢che √† la fois.</li>
                </ul>
            </div>
        </div>

        <div id="agenda" class="content-section">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 style="margin: 0;"> üìÖ Mon planning</h2>
            <button onclick="saveAgenda()" style="background: var(--marron); color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8rem;">Enregistrer üíæ</button>
        </div>
        
        <div id="calendar-container" style="display: flex; flex-direction: column; gap: 12px;">
            </div>
        
        <p style="font-size: 0.75rem; color: var(--marron-clair); margin-top: 15px; text-align: center;">
            Clique sur les textes pour modifier ton programme.
        </p>
    </div>
</div>
<div id="chat" class="content-section">
    <div class="card">
        <h2>üí¨ Discussion</h2>
        <div id="chatBox" style="height: 300px; overflow-y: auto; border: 1px solid var(--gris-leger); padding: 10px; border-radius: 12px; margin-bottom: 10px; background: #fdfdfd; display: flex; flex-direction: column; gap: 8px;">
            </div>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="chatInput" placeholder="√âcris un message...">
            <button onclick="sendMessage()" style="background: var(--vert-fonce); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer;">Envoyer</button>
        </div>
    </div>
</div>
    </div>

    <script>
       const SUPABASE_URL = 'https://gdxfrbetccvzcrnbsqzg.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_1iqAe46EAtTc2b1MnNjSng_OUOpTFWm';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let isLoginMode = true;

        // --- AUTH ---
        function toggleDarkMode() {
    // Ajoute ou retire la classe .dark-mode au body
    document.body.classList.toggle('dark-mode');
    
    // Sauvegarder la pr√©f√©rence de l'utilisateur
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDark);
}

// V√©rifier au chargement de la page si l'utilisateur pr√©f√©rait le mode sombre
window.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
    }
});

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-title').innerText = isLoginMode ? "Connexion" : "Inscription";
            document.getElementById('switch-btn').innerText = isLoginMode ? "S'inscrire" : "D√©j√† un compte ? Connexion";
        }

        async function signIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if (isLoginMode) {
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) alert(error.message); else checkUser();
            } else {
                const { error } = await supabaseClient.auth.signUp({ email, password });
                if (error) alert(error.message); else { alert("Compte cr√©√© !"); checkUser(); }
            }
        }

        async function signOut() { await supabaseClient.auth.signOut(); checkUser(); }

        async function checkUser() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            document.getElementById('auth-screen').style.display = user ? 'none' : 'flex';
            document.getElementById('main-interface').style.display = user ? 'flex' : 'none';
            if (user) {
                loadTasks();
                setupCalendar();
            }
        }

        // --- T√ÇCHES ---
        async function loadTasks() {
            const { data: tasks, error } = await supabaseClient.from('tasks').select('*').order('created_at', { ascending: false });
            if (!error) {
                const list = document.getElementById("taskList");
                list.innerHTML = "";
                tasks.forEach(t => {
                    let div = document.createElement("div");
                    div.className = "task-item";
                    div.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" ${t.is_completed ? 'checked' : ''} onchange="toggleTaskStatus('${t.id}', this.checked)">
                            <span style="text-decoration: ${t.is_completed ? 'line-through' : 'none'}">${t.text}</span>
                        </div>
                        <button onclick="deleteTask('${t.id}')" style="background:none; border:none; cursor:pointer;">üóëÔ∏è</button>`;
                    list.appendChild(div);
                });
            }
        }

        async function addTask() {
            const input = document.getElementById("taskInput");
            if (!input.value) return;
            const { data: { user } } = await supabaseClient.auth.getUser();
            await supabaseClient.from('tasks').insert([{ text: input.value, user_id: user.id }]);
            input.value = "";
            loadTasks();
        }

        async function toggleTaskStatus(id, isCompleted) {
            await supabaseClient.from('tasks').update({ is_completed: isCompleted }).eq('id', id);
            loadTasks();
        }

        async function deleteTask(id) {
            await supabaseClient.from('tasks').delete().eq('id', id);
            loadTasks();
        }

        // --- POMODORO ---
        let timeLeft = 1500; let timerId = null;
        function toggleTimer() {
            if (timerId) { clearInterval(timerId); timerId = null; document.getElementById('startBtn').innerText = "D√©marrer"; }
            else { timerId = setInterval(updateTimer, 1000); document.getElementById('startBtn').innerText = "Pause"; }
        }
        function updateTimer() {
            if (timeLeft <= 0) { clearInterval(timerId); alert("Temps √©coul√© !"); return; }
            timeLeft--;
            const m = Math.floor(timeLeft / 60); const s = timeLeft % 60;
            document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        }
        function resetTimer() { clearInterval(timerId); timerId = null; timeLeft = 1500; document.getElementById('timer').innerText = "25:00"; }

        // --- CUISINE & CIN√â ---
        const recipes = [
            { nom: "P√¢tes Pesto Rosso üçù", ingredients: ["150g de p√¢tes", "Pesto Rosso", "Parmesan"], methode: "Cuire les p√¢tes. M√©langer le pesto avec un peu d'eau de cuisson. Servir avec le parmesan.", pret: "10 min" },
            { nom: "Salade Feta Avocat ü•ó", ingredients: ["1 Avocat", "50g de Feta", "Roquette"], methode: "D√©noyauter l'avocat, couper en d√©s avec la feta. M√©langer sur un lit de roquette.", pret: "5 min" },
            { nom: "Omelette Champignons üç≥", ingredients: ["3 ≈ìufs", "4 champignons", "Persil"], methode: "Po√™ler les champignons. Battre les ≈ìufs et verser par dessus. Cuire √† feu doux.", pret: "8 min" },
            { nom: "Gratin Dauphinois ü•î", ingredients: ["Pommes de terre", "Cr√®me", "Ail"], methode: "Trancher finement les patates. Ranger dans un plat avec cr√®me et ail. Cuire 45min √† 180¬∞C.", pret: "1h" }
        ];

        const movies = [
            { titre: "Inception üåÄ", resume: "Un voleur s'infiltre dans les r√™ves pour y implanter des id√©es." },
            { titre: "Intouchables üçø", resume: "L'histoire vraie d'une amiti√© entre un riche aristocrate et son aide √† domicile." },
            { titre: "Interstellar üöÄ", resume: "Un voyage spatial √† travers un trou de ver pour sauver l'humanit√©." },
            { titre: "Le Voyage de Chihiro ‚õ©Ô∏è", resume: "Une fillette perdue dans un monde fantastique dirig√© par une sorci√®re." },
            { titre: "Spider-Man üï∑Ô∏è", resume: "Un lyc√©en acquiert des super-pouvoirs apr√®s une morsure d'araign√©e." }
        ];

        function randomRecipe() {
            const c = recipes[Math.floor(Math.random() * recipes.length)];
            document.getElementById('recipeDisplay').innerHTML = `
                <h3 style="margin-bottom:5px;">${c.nom}</h3>
                <small>‚è≥ ${c.pret}</small>
                <p><b>Ingr√©dients:</b> ${c.ingredients.join(', ')}</p>
                <p style="background:var(--blanc-fond); padding:10px; border-radius:10px; font-size:0.9rem;"><b>Pr√©paration:</b> ${c.methode}</p>
            `;
        }

        function randomMovie() {
            const m = movies[Math.floor(Math.random() * movies.length)];
            document.getElementById('movieDisplay').innerHTML = `
                <div style="font-size:1.1rem; margin-bottom:5px;">${m.titre}</div>
                <div style="font-weight:normal; font-size:0.85rem; color:#666;">${m.resume}</div>
            `;
        }

        // --- BIEN-ETRE & CONSEILS ---
        function generateWorkout() {
            const ex = [
                { nom: "Squats ü¶µ", desc: "Gardez le dos droit.", reps: "3x15" },
                { nom: "Gainage üß±", desc: "Appui sur avant-bras.", reps: "45 sec" }
            ];
            const c = ex[Math.floor(Math.random() * ex.length)];
            document.getElementById('workoutTitle').innerText = c.nom;
            document.getElementById('workoutDesc').innerText = c.desc;
            document.getElementById('workoutRep').innerText = "üéØ " + c.reps;
            document.getElementById('workoutBox').style.display = "block";
        }

        function startBreathing() {
            const t = document.getElementById('breathText');
            t.innerText = "Inspirez...";
            setTimeout(() => { t.innerText = "Bloquez..."; 
                setTimeout(() => { t.innerText = "Expirez..."; 
                    setTimeout(() => { t.innerText = "Termin√© ! ‚ú®"; }, 4000);
                }, 4000);
            }, 4000);
        }

        function generateTip() {
            const tips = ["R√®gle des 2 min", "Mange le crapaud üê∏", "Mode avion üìµ"];
            document.getElementById('tipText').innerText = tips[Math.floor(Math.random() * tips.length)];
            document.getElementById('tipBox').style.display = "block";
        }

        // --- NAVIGATION & AGENDA ---
        function openTab(evt, tabName) {
    let contents = document.getElementsByClassName("content-section");
    for (let c of contents) c.classList.remove("active");
    let buttons = document.getElementsByClassName("tab-btn");
    for (let b of buttons) b.classList.remove("active");
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");

    // Ajoute cette ligne pour charger le chat quand on clique dessus
    if (tabName === 'chat') loadMessages();
}

        async function setupCalendar() {
            const jours = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"];
            const container = document.getElementById('calendar-container');
            const { data: { user } } = await supabaseClient.auth.getUser();

            const { data: savedData } = await supabaseClient.from('agenda').select('*').eq('user_id', user.id);

            container.innerHTML = ""; 

            jours.forEach(jour => {
                const entry = savedData ? savedData.find(d => d.day_name === jour) : null;
                // Logique pour afficher "Rien de pr√©vu" si vide ou null
                const matin = (entry && entry.morning_text && entry.morning_text !== "null") ? entry.morning_text : "RIEN DE PR√âVU";
                const am = (entry && entry.afternoon_text && entry.afternoon_text !== "null") ? entry.afternoon_text : "RIEN DE PR√âVU";
                const soir = (entry && entry.evening_text && entry.evening_text !== "null") ? entry.evening_text : "RIEN DE PR√âVU";

                container.innerHTML += `
                    <div style="border: 1px solid var(--gris-leger); border-radius: 15px; padding: 12px; background: #fff; margin-bottom:10px;">
                        <div style="font-weight: bold; color: var(--vert-fonce); border-bottom: 1px solid var(--gris-leger); margin-bottom: 8px; padding-bottom: 4px;">${jour}</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div>
                                <small style="color: var(--marron-clair); font-weight: 600;">‚òÄÔ∏è MATIN</small>
                                <div class="edit-agenda" data-day="${jour}" data-time="morning" contenteditable="true" style="font-size: 0.85rem; color: #555; outline: none;">${matin}</div>
                            </div>
                            <div>
                                <small style="color: var(--marron-clair); font-weight: 600;">‚õÖ A-M</small>
                                <div class="edit-agenda" data-day="${jour}" data-time="afternoon" contenteditable="true" style="font-size: 0.85rem; color: #555; outline: none;">${am}</div>
                            </div>
                            <div>
                                <small style="color: var(--marron-clair); font-weight: 600;">üåô SOIR</small>
                                <div class="edit-agenda" data-day="${jour}" data-time="evening" contenteditable="true" style="font-size: 0.85rem; color: #555; outline: none;">${soir}</div>
                            </div>
                        </div>
                    </div>`;
            });
        }

        async function saveAgenda() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            const jours = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"];
            
            const updates = jours.map(jour => ({
                user_id: user.id,
                day_name: jour,
                morning_text: document.querySelector(`.edit-agenda[data-day="${jour}"][data-time="morning"]`).innerText,
                afternoon_text: document.querySelector(`.edit-agenda[data-day="${jour}"][data-time="afternoon"]`).innerText,
                evening_text: document.querySelector(`.edit-agenda[data-day="${jour}"][data-time="evening"]`).innerText
            }));

            const { error } = await supabaseClient.from('agenda').upsert(updates, { onConflict: 'user_id,day_name' });
            if (error) alert("Erreur : " + error.message); else alert("Agenda synchronis√© ! ‚òÅÔ∏è");
        }
        async function loadMessages() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    const { data: messages, error } = await supabaseClient
        .from('messages')
        .select('*')
        .order('created_at', { ascending: true });

    if (!error) {
        const chatBox = document.getElementById("chatBox");
        chatBox.innerHTML = messages.map(m => {
            const isMine = m.user_id === user.id; // V√©rifie si c'est ton message
            return `
            <div style="display: flex; flex-direction: column; align-items: ${isMine ? 'flex-end' : 'flex-start'}; gap: 2px; width: 100%;">
                <div style="background: ${isMine ? 'var(--marron-clair)' : 'var(--gris-leger)'}; 
                            color: ${isMine ? 'white' : 'black'}; 
                            padding: 8px 12px; border-radius: 12px; max-width: 80%; position: relative;">
                    <small style="display:block; font-size:0.6rem; opacity: 0.8;">${m.user_email.split('@')[0]}</small>
                    <div style="font-size: 0.9rem;">${m.text}</div>
                    ${isMine ? `<button onclick="deleteMessage('${m.id}')" style="background:none; border:none; cursor:pointer; font-size:0.7rem; margin-top:5px; color:white; opacity:0.6;"> üóëÔ∏è</button>` : ''}
                </div>
            </div>`;
        }).join('');
        chatBox.scrollTop = chatBox.scrollHeight;
    }
}

async function sendMessage() {
    const input = document.getElementById("chatInput");
    if (!input.value) return;

    const { data: { user } } = await supabaseClient.auth.getUser();
    
    await supabaseClient.from('messages').insert([
        { text: input.value, user_id: user.id, user_email: user.email }
    ]);

    input.value = "";
    loadMessages();
    document.getElementById("chatInput").addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
        event.preventDefault();
        sendMessage();
    }
});
}
async function deleteMessage(messageId) {
    if (confirm("Voulez-vous vraiment supprimer ce message ?")) {
        const { error } = await supabaseClient
            .from('messages')
            .delete()
            .eq('id', messageId);

        if (error) {
            alert("Erreur lors de la suppression : " + error.message);
        } else {
            loadMessages(); // Recharge le chat apr√®s suppression
        }
    }
}
window.onload = checkUser;

// √âcouter les nouveaux messages en temps r√©el
supabaseClient
  .channel('schema-db-changes')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => {
    loadMessages();
  })
  .subscribe();
  let currentGroupId = null; // null = Discussion g√©n√©rale

async function createGroup() {
    const name = document.getElementById("groupNameInput").value;
    if (!name) return;

    const { error } = await supabaseClient.from('groups').insert([{ name: name }]);
    if (error) alert(error.message);
    else {
        document.getElementById("groupNameInput").value = "";
        loadGroups();
    }
}

async function loadGroups() {
    const { data: groups, error } = await supabaseClient.from('groups').select('*');
    if (!error) {
        const list = document.getElementById("groupsList");
        // On garde le bouton G√©n√©ral
        list.innerHTML = `<button onclick="selectGroup(null)" class="tab-btn ${currentGroupId === null ? 'active' : ''}">üåç G√©n√©ral</button>`;
        
        groups.forEach(g => {
            list.innerHTML += `
                <button onclick="selectGroup('${g.id}')" class="tab-btn ${currentGroupId === g.id ? 'active' : ''}">
                    üë• ${g.name}
                </button>`;
        });
    }
}

function selectGroup(id) {
    currentGroupId = id;
    loadGroups(); // Pour mettre √† jour l'apparence des boutons
    loadMessages(); // Pour charger les messages du groupe
}

// MODIFIER loadMessages pour filtrer par groupe
async function loadMessages() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    
    let query = supabaseClient.from('messages').select('*');
    
    // Filtrage : soit group_id est celui choisi, soit il est vide pour le g√©n√©ral
    if (currentGroupId) {
        query = query.eq('group_id', currentGroupId);
    } else {
        query = query.is('group_id', null);
    }

    const { data: messages, error } = await query.order('created_at', { ascending: true });

    if (!error) {
        const chatBox = document.getElementById("chatBox");
        chatBox.innerHTML = messages.map(m => {
            const isMine = m.user_id === user.id;
            return `
            <div style="display: flex; flex-direction: column; align-items: ${isMine ? 'flex-end' : 'flex-start'}; width: 100%;">
                <div style="background: ${isMine ? 'var(--marron-clair)' : 'var(--gris-leger)'}; color: ${isMine ? 'white' : 'black'}; padding: 8px 12px; border-radius: 12px; max-width: 80%;">
                    <small style="display:block; font-size:0.6rem; opacity: 0.8;">${m.user_email ? m.user_email.split('@')[0] : 'Anonyme'}</small>
                    <div>${m.text}</div>
                    ${isMine ? `<button onclick="deleteMessage('${m.id}')" style="background:none; border:none; cursor:pointer; font-size:0.7rem; color:inherit; opacity:0.5;">Effacer</button>` : ''}
                </div>
            </div>`;
        }).join('');
        chatBox.scrollTop = chatBox.scrollHeight;
    }
}

// MODIFIER sendMessage pour inclure le group_id
async function sendMessage() {
    const input = document.getElementById("chatInput");
    if (!input.value) return;

    const { data: { user } } = await supabaseClient.auth.getUser();
    
    await supabaseClient.from('messages').insert([
        { 
            text: input.value, 
            user_id: user.id, 
            user_email: user.email,
            group_id: currentGroupId // On lie le message au groupe actuel
        }
    ]);

    input.value = "";
    loadMessages();
}

// Appelle loadGroups quand on arrive sur l'onglet chat
// Dans ta fonction openTab actuelle, ajoute :
// if (tabName === 'chat') { loadGroups(); loadMessages(); }
    </script>
</body>
</html>
